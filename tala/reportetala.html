<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Geoportal de Reportes ‚Äì Tala Ilegal</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body{margin:0;font-family:Inter,Arial;background:#f3f4f6;}
    header{background:#990033;color:#fff;padding:20px;font-size:20px;font-weight:600;}
    .app{display:grid;grid-template-columns:1fr 420px;height:calc(100vh - 72px);}
    #map{width:100%;height:100%;}
    .sidebar{background:#fff;padding:20px;overflow-y:auto;border-left:1px solid #e5e7eb;}
    h2{margin-bottom:15px;}
    label{font-size:14px;}
    input, textarea{width:100%;padding:10px;margin-top:5px;margin-bottom:10px;border:1px solid #d1d5db;border-radius:8px;}
    textarea{resize:none;height:80px;}
    .coords{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    button{
      width:100%;padding:12px;border:none;border-radius:10px;
      font-size:14px;font-weight:500;color:#fff;cursor:pointer;
      margin-bottom:10px;
    }

    .btn-primary{background:#2563eb;}
    .btn-location{background:#059669;}
    .btn-track{background:#7c3aed;}
    .btn-route{background:#0d9488;}
    .btn-export{background:#334155;}

    .status{font-size:13px;font-weight:600;margin-top:5px;}

    .leaflet-control-layers{
      background:#fff;border-radius:16px;padding:10px;border:1px solid #e5e7eb;
      box-shadow:0 12px 30px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>

<header>üå≤ Geoportal de Reportes ‚Äì Tala Ilegal (M√©xico)</header>

<div class="app">

  <div id="map"></div>

  <!-- SIDEBAR -->
  <div class="sidebar">

    <h2>Nuevo reporte</h2>

    <form id="formReporte">
      <label>Tipo de reporte</label>
      <input id="titulo" required>

      <label>Descripci√≥n</label>
      <textarea id="descripcion" required></textarea>

      <div class="coords">
        <div>
          <label>Latitud</label>
          <input id="lat" readonly>
        </div>
        <div>
          <label>Longitud</label>
          <input id="lng" readonly>
        </div>
      </div>

      <button type="button" id="btnUbicacion" class="btn-location">üìç Usar mi ubicaci√≥n</button>
      <button type="button" id="btnSeguimiento" class="btn-track">üì° Seguimiento en tiempo real</button>
      <div id="precisionGps" style="font-size:12px;margin-bottom:10px;color:#6b7280;"></div>

      <button type="submit" class="btn-primary">Guardar reporte</button>
      <div id="estado" class="status"></div>
    </form>

    <hr>
    <h2>Rutas GPS</h2>

    <button id="btnStartRoute" class="btn-route">‚ñ∂ Iniciar grabaci√≥n de ruta</button>
    <button id="btnStopRoute" class="btn-route" style="background:#be123c;">‚èπ Detener grabaci√≥n</button>

    <button id="btnGuardarRuta" class="btn-primary">üíæ Guardar ruta en Supabase</button>

    <button id="btnExportRoute" class="btn-export">‚¨á Exportar ruta (GeoJSON)</button>
    <button id="btnExportKML" class="btn-export">‚¨á Exportar ruta (KML)</button>

    <hr>

    <h2>Zonas Cr√≠ticas</h2>
    <button id="btnDibujarPoligono" class="btn-route">‚úè Dibujar zona cr√≠tica</button>

    <hr>

    <label style="display:flex;gap:10px;align-items:center;margin-top:10px;">
      <input id="toggleReportes" type="checkbox" checked>
      Mostrar reportes en el mapa
    </label>

    <div id="contadorReportes" style="font-size:13px;color:#6b7280;margin-top:5px;"></div>

  </div>
</div>

<script>

  /* ============================================================
     CONFIGURACI√ìN SUPABASE
  ============================================================ */
  const supabaseUrl = "https://tcejcwfocunsozsnahge.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZWpjd2ZvY3Vuc296c25haGdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTg1NDIsImV4cCI6MjA4MDM5NDU0Mn0.XhgwFT0_HCqm2dCq6_Bedmx-JAQFfzOdQfAGfap5IBk";
  const clienteSupabase = supabase.createClient(supabaseUrl, supabaseKey);

  /* ============================================================
     MAPA BASE
  ============================================================ */
  const map = L.map("map").setView([23.6345, -102.5528], 6);

  const capaCalles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const capaReportes = L.layerGroup().addTo(map);
  const capaZonas = new L.FeatureGroup().addTo(map);

  L.control.layers(
    { "Calles (OSM)": capaCalles },
    { "Reportes": capaReportes, "Zonas cr√≠ticas": capaZonas }
  ).addTo(map);


  /* ============================================================
     CARGAR REPORTES DESDE SUPABASE
  ============================================================ */
  async function cargarReportes() {
    capaReportes.clearLayers();

    const { data, error } = await clienteSupabase.from("reportes").select("*");

    if (data) {
      data.forEach(r => {
        if (r.latitud && r.longitud) {
          L.marker([r.latitud, r.longitud])
            .bindPopup(`<b>${r.titulo}</b><br>${r.descripcion}`)
            .addTo(capaReportes);
        }
      });

      contadorReportes.innerText = `Reportes: ${data.length}`;
    }
  }

  cargarReportes();

  toggleReportes.addEventListener("change", function() {
    this.checked ? map.addLayer(capaReportes) : map.removeLayer(capaReportes);
  });


  /* ============================================================
     SELECCI√ìN DE COORDENADAS CON CLICK
  ============================================================ */
  let tempMarker = null;

  map.on("click", e => {
    const { lat, lng } = e.latlng;

    document.getElementById("lat").value = lat.toFixed(6);
    document.getElementById("lng").value = lng.toFixed(6);

    if (!tempMarker)
      tempMarker = L.marker([lat, lng]).addTo(map);
    else
      tempMarker.setLatLng([lat, lng]);
  });


  /* ============================================================
     GEOLOCALIZACI√ìN √öNICA
  ============================================================ */
  btnUbicacion.onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      document.getElementById("lat").value = lat.toFixed(6);
      document.getElementById("lng").value = lng.toFixed(6);

      map.flyTo([lat, lng], 17);

      if (!tempMarker)
        tempMarker = L.marker([lat, lng]).addTo(map);
      else
        tempMarker.setLatLng([lat, lng]);
    });
  };


  /* ============================================================
     SEGUIMIENTO GPS EN TIEMPO REAL
  ============================================================ */
  let watchId = null;
  let markerGPS = null;

  btnSeguimiento.onclick = () => {
    if (!watchId) {

      btnSeguimiento.innerText = "üõë Detener seguimiento";
      btnSeguimiento.style.background = "#dc2626";

      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        precisionGps.innerText = `Precisi√≥n: ¬±${Math.round(pos.coords.accuracy)} m`;

        document.getElementById("lat").value = lat.toFixed(6);
        document.getElementById("lng").value = lng.toFixed(6);

        if (!markerGPS)
          markerGPS = L.marker([lat, lng]).addTo(map);
        else
          markerGPS.setLatLng([lat, lng]);

        map.setView([lat, lng], 18);
      });

    } else {

      navigator.geolocation.clearWatch(watchId);
      watchId = null;

      btnSeguimiento.innerText = "üì° Seguimiento en tiempo real";
      btnSeguimiento.style.background = "#7c3aed";
      precisionGps.innerText = "";
    }
  };


  /* ============================================================
     GUARDAR REPORTE EN SUPABASE
  ============================================================ */
  formReporte.onsubmit = async e => {
    e.preventDefault();

    const titulo = document.getElementById("titulo").value;
    const descripcion = document.getElementById("descripcion").value;
    const lat = document.getElementById("lat").value;
    const lng = document.getElementById("lng").value;

    const { error } = await clienteSupabase.from("reportes")
      .insert([{ titulo, descripcion, latitud: lat, longitud: lng }]);

    if (error) {
      estado.innerText = "‚ùå Error: " + error.message;
      estado.style.color = "red";
    } else {
      estado.innerText = "‚úÖ Reporte guardado";
      estado.style.color = "green";
      formReporte.reset();
      cargarReportes();
    }
  };


  /* ============================================================
     GRABACI√ìN DE RUTAS GPS
  ============================================================ */
  let grabandoRuta = false;
  let rutaCoords = [];
  let lineaRuta = null;

  btnStartRoute.onclick = () => {
    grabandoRuta = true;
    rutaCoords = [];
    alert("Grabaci√≥n iniciada. Se registrar√° tu movimiento GPS.");
  };

  btnStopRoute.onclick = () => {
    grabandoRuta = false;
    alert("Grabaci√≥n detenida.");
  };

  navigator.geolocation.watchPosition(pos => {
    if (!grabandoRuta) return;

    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const point = [lat, lng];

    rutaCoords.push(point);

    if (!lineaRuta)
      lineaRuta = L.polyline(rutaCoords, { color: "red" }).addTo(map);
    else
      lineaRuta.setLatLngs(rutaCoords);

  });


  /* ============================================================
     GUARDAR RUTA EN SUPABASE (LineString)
  ============================================================ */
  btnGuardarRuta.onclick = async () => {
    if (rutaCoords.length < 2) {
      alert("No hay suficiente informaci√≥n en la ruta.");
      return;
    }

    const nombreRuta = prompt("Nombre de esta ruta:");

    if (!nombreRuta) return;

    const geojsonLinea = {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: rutaCoords.map(c => [c[1], c[0]]) // lng, lat
      }
    };

    const { error } = await clienteSupabase
      .from("rutas_gps")
      .insert([{ nombre: nombreRuta, geom: geojsonLinea }]);

    if (error) {
      alert("Error guardando ruta: " + error.message);
    } else {
      alert("Ruta guardada correctamente en Supabase.");
    }
  };


  /* ============================================================
     EXPORTAR GEOJSON
  ============================================================ */
  btnExportRoute.onclick = () => {
    if (rutaCoords.length < 2) {
      alert("No hay datos suficientes.");
      return;
    }

    const geojson = {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: rutaCoords.map(c => [c[1], c[0]])
      }
    };

    const blob = new Blob([JSON.stringify(geojson)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "ruta.geojson";
    a.click();
  };


  /* ============================================================
     EXPORTAR KML
  ============================================================ */
  btnExportKML.onclick = () => {
    if (rutaCoords.length < 2) {
      alert("No hay datos suficientes.");
      return;
    }

    const kml = `
    <?xml version="1.0" encoding="UTF-8"?>
    <kml xmlns="http://www.opengis.net/kml/2.2">
      <Document>
        <Placemark>
          <name>Ruta GPS</name>
          <LineString>
            <coordinates>
              ${rutaCoords.map(c => `${c[1]},${c[0]},0`).join(" ")}
            </coordinates>
          </LineString>
        </Placemark>
      </Document>
    </kml>
    `;

    const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "ruta.kml";
    a.click();
  };


  /* ============================================================
     DIBUJAR ZONAS CR√çTICAS + GUARDAR EN SUPABASE
  ============================================================ */
  const drawControl = new L.Control.Draw({
    edit: { featureGroup: capaZonas },
    draw: {
      polygon: true,
      rectangle: true,
      circle: false,
      marker: false,
      polyline: false
    }
  });

  btnDibujarPoligono.onclick = () => {
    map.addControl(drawControl);
    alert("Dibuja una zona cr√≠tica en el mapa.");
  };

  map.on(L.Draw.Event.CREATED, async function (e) {
    capaZonas.addLayer(e.layer);

    const geojson = e.layer.toGeoJSON();
    const titulo = prompt("Nombre de esta zona cr√≠tica:");

    if (!titulo) return;

    const { error } = await clienteSupabase
      .from("zonas_criticas")
      .insert([{ titulo, geom: geojson }]);

    if (error)
      alert("Error guardando zona: " + error.message);
    else
      alert("Zona cr√≠tica guardada en Supabase.");
  });

  /* ============================================================
     BUSCADOR DE LOCALIDADES (CONTROL PERSONALIZADO)
  ============================================================ */

  // Crear control de b√∫squeda
  const SearchControl = L.Control.extend({
    onAdd: function(map) {
      const container = L.DomUtil.create('div', 'search-control');
      container.style.background = 'white';
      container.style.padding = '8px';
      container.style.borderRadius = '8px';
      container.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
      container.style.width = '320px';
      container.style.maxHeight = '320px';
      container.style.overflow = 'auto';
      container.style.fontFamily = 'Inter, Arial';
      container.innerHTML = `
        <input id="inputSearch" placeholder="Buscar localidad en M√©xico..." style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:6px;">
        <div id="searchResults" style="font-size:13px;"></div>
      `;
      // evitar que el mapa reciba clicks cuando se escribe
      L.DomEvent.disableClickPropagation(container);
      return container;
    }
  });

  const searchControl = new SearchControl({ position: 'topleft' });
  map.addControl(searchControl);

  const inputSearch = document.getElementById('inputSearch');
  const searchResults = document.getElementById('searchResults');
  let marcadorBusqueda = null;
  let searchTimeout = null;

  inputSearch.addEventListener('input', function() {
    const q = this.value.trim();
    searchResults.innerHTML = '';
    if (q.length < 3) return;

    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      searchResults.innerHTML = '<div style="color:#6b7280;padding:6px">Buscando‚Ä¶</div>';
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=mx&limit=8&q=${encodeURIComponent(q)}`);
        const data = await res.json();

        if (!data.length) {
          searchResults.innerHTML = '<div style="color:#9ca3af;padding:6px">Sin resultados</div>';
          return;
        }

        searchResults.innerHTML = '';
        data.forEach(place => {
          const item = document.createElement('div');
          item.style.padding = '6px';
          item.style.cursor = 'pointer';
          item.style.borderBottom = '1px solid #f3f4f6';
          item.innerHTML = `<strong style="font-size:13px">${place.display_name}</strong>`;
          item.onclick = () => {
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);

            map.flyTo([lat, lon], 15);

            if (!marcadorBusqueda) {
              marcadorBusqueda = L.marker([lat, lon]).addTo(map);
            } else {
              marcadorBusqueda.setLatLng([lat, lon]);
            }

            marcadorBusqueda.bindPopup(`üìç ${place.display_name}`).openPopup();

            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lon.toFixed(6);

            searchResults.innerHTML = `<div style="color:#16a34a;padding:6px">Ubicaci√≥n seleccionada ‚úÖ</div>`;
            inputSearch.value = place.display_name;
          };
          searchResults.appendChild(item);
        });

      } catch (err) {
        searchResults.innerHTML = '<div style="color:#ef4444;padding:6px">Error en la b√∫squeda</div>';
        console.error(err);
      }
    }, 350);
  });


  /* ============================================================
     CARGAR RUTAS Y ZONAS GUARDADAS (AL INICIAR)
  ============================================================ */
  async function cargarRutasGuardadas() {
    // Cargar rutas (rutas_gps)
    const { data: rutas, error: errRutas } = await clienteSupabase.from('rutas_gps').select('*');
    if (errRutas) {
      console.error('Error cargando rutas:', errRutas.message);
    } else if (rutas) {
      rutas.forEach(r => {
        try {
          const geo = r.geom;
          if (geo && geo.geometry && geo.geometry.type === 'LineString') {
            const coords = geo.geometry.coordinates.map(c => [c[1], c[0]]); // lat,lng
            L.polyline(coords, { color: '#ff4500', weight: 4, opacity: 0.8 })
              .bindPopup(`<b>${r.nombre}</b><br>${new Date(r.fecha).toLocaleString()}`)
              .addTo(map);
          }
        } catch (e) {
          console.warn('Formato ruta inv√°lido', e);
        }
      });
    }

    // Cargar zonas cr√≠ticas (zonas_criticas)
    const { data: zonas, error: errZonas } = await clienteSupabase.from('zonas_criticas').select('*');
    if (errZonas) {
      console.error('Error cargando zonas:', errZonas.message);
    } else if (zonas) {
      zonas.forEach(z => {
        try {
          const gj = z.geom;
          const layer = L.geoJSON(gj, {
            style: { color: '#8b0000', fillOpacity: 0.2, weight: 2 }
          }).bindPopup(`<b>${z.titulo}</b><br>${new Date(z.fecha).toLocaleString()}`);
          capaZonas.addLayer(layer);
        } catch (e) {
          console.warn('Formato zona inv√°lido', e);
        }
      });
    }
  }

  // Ejecutar cargas iniciales
  cargarRutasGuardadas();


  /* ============================================================
     LIMPIEZA: quitar control de dibujo cuando el usuario termina edici√≥n
  ============================================================ */
  map.on('draw:deleted', function(e) {
    // Opcional: podr√≠as implementar borrado en Supabase,
    // por ahora solo se elimina visualmente del mapa.
  });

  map.on('draw:edited', function(e) {
    // Edici√≥n local: si quieres sincronizar cambios con la base,
    // implementa aqu√≠ la actualizaci√≥n a Supabase.
  });


  /* ============================================================
     FIN DEL SCRIPT / CIERRE
  ============================================================ */

</script>
</body>
</html>
